<html>
<head><meta charset="utf-8">
<title>Riff Lightning Diffusion</title>
</head>
<body>
    

    <h1>Riff Lightning Diffusion</h1>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>

    <script>
        // override default prompt with URL parameter
        var urlParams = new URLSearchParams(window.location.search);
        var n = 3;
        if (urlParams.has('n')) {
            n = parseInt(urlParams.get('n'));
        }
        var steps = 15;
        if (urlParams.has('steps')) {
            steps = urlParams.get('steps');
            steps = parseInt(steps);
        }
        var strength = 0.6;
        if (urlParams.has('strength')) {
            strength = parseFloat(urlParams.get('strength'));
        }
        var seed = 1512;
        if (urlParams.has('seed')) {
            seed = urlParams.get('seed');
            seed = parseInt(seed);
        }
        var factor = 1.3;
        if (urlParams.has('factor')) {
            factor = urlParams.get('factor');
            factor = parseFloat(factor);
        }
        var strengthfactor = 0.9;
        if (urlParams.has('strengthfactor')) {
            strengthfactor = urlParams.get('strengthfactor');
            strengthfactor = parseFloat(strengthfactor);
        }
        
        var onGenerateClickFn =function() {
            var prompt = $('#prompt').val();
            $('#output').html('');
            
            for (var i = 0; i < n; i++) {
                var img = $('<img>');
                var Href = '/?prompt=' + encodeURIComponent(prompt)+'&steps='+steps+'&seed=' + (seed + i+1);
                img.attr('src', Href);
                img.click(imageClick);
                $('#output').append(img);
            }            
        }
        var imageClick = function(){
            theimg = $(this);
            var url = theimg.attr('src');            
            var urlParams2 = new URLSearchParams(url.split('?')[1]);
            var prompt = $('#prompt').val();
            var newsteps = parseInt(urlParams2.get('steps'));
            var newstrength = parseFloat(urlParams2.get('strength'));
            var newseed = parseInt(urlParams2.get('seed'));
            var oldprompt = urlParams2.get('prompt');
            if(oldprompt == prompt){ 
                newsteps = newsteps * factor;
                newsteps = Math.round(newsteps);
                newsteps = Math.max(newsteps, 1);
                newsteps = Math.min(newsteps, 200);
                newstrength = newstrength * strengthfactor;
            }
            else{
                const newPromptMode = 'normal';
                if(urlParams.has('newPromptMode')) {
                    newPromptMode = urlParams.get('newPromptMode');
                }
                if(newPromptMode == 'decrease'){
                    newsteps = newsteps / factor;
                    newsteps = Math.round(newsteps);
                    newsteps = Math.max(newsteps, 1);
                    newsteps = Math.min(newsteps, 200);
                    newstrength = newstrength / strengthfactor;
                }
                else if(newPromptMode == 'random'){
                    newsteps = Math.round(Math.random() * 200);
                    newsteps = Math.max(newsteps, 1);
                    newsteps = Math.min(newsteps, 200);
                    newstrength = Math.random();
                }
                else if(newPromptMode == 'keep'){
                    newsteps = newsteps;
                    newstrength = newstrength;
                }
                else{
                    newsteps = steps;
                    newstrength = strength;
                }                
            }


            $('#output').html('');
            for(var i = 0; i < n; i++){
                var img = $('<img>');
                var newHref = '/?prompt=' + encodeURIComponent(prompt)+'&steps='+newsteps+'&seed='+(newseed+i+1)+"&strength="+newstrength + "&origImage=" + encodeURIComponent(url);
                img.attr('src', newHref);
                img.click(imageClick);
                $('#output').append(img);
            }
        }
        var onReplaceFn = function(){
            // get the images
            var imgs = $('#output img');
            var replaceStr = $('#replace').val();
            var withStr = $('#with').val();
            // replace ALL words with new word in each image url
            for(var i = 0; i < imgs.length; i++){
                var img = $(imgs[i]);
                var url = img.attr('src');                
                newUrl = url.replaceAll(replaceStr, withStr);
                img.attr('src', newUrl);
            }
            // replace in current prompt
            var prompt = $('#prompt').val();
            var newprompt = prompt.replaceAll(replaceStr, withStr);
            if(newprompt != prompt){
                $('#prompt').val(newprompt);                
            }            
        }

    </script>
    <style type="text/css">
        body {
            font-family: sans-serif;
        }
        #output img {
            width: 100%;
            max-width: 400px;
            margin: 10px;
        }
        #output {
            display: flex;
            flex-wrap: wrap;
        }
        #prompt {
            width: 100%;
            max-width: 400px;
        }
        #replace {
            width: 100%;
            max-width: 400px;
        }
        #with {
            width: 100%;
            max-width: 400px;
        }
    </style>
    <!-- two forms side by side -->
    <div id="forms">
        <form onsubmit="onGenerateClickFn" id="form1">
            <label for="prompt">Prompt:</label>
            <input type="text" id="prompt" value=""></input>
            <input type="button" value="Generate" onclick="onGenerateClickFn()"></input>
        </form>
        <form onsubmit="onReplaceFn" id="form2">
            <label for="replace">Replace:</label>
            <input type="text" id="replace"></input>
            <label for="with">With:</label>
            <input type="text" id="with"></input>
            <input type="button" value="Replace" onclick="onReplaceFn()"></input>
        </form>
    </div>
    <div id="output"></div>
    <script>
        var defaultPrompt = "photo of a unicorn";
        // override default prompt with URL parameter
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('prompt')) {
            defaultPrompt = urlParams.get('prompt');
        }
        $("#prompt").val(defaultPrompt);
        $('#generate').click(onGenerateClickFn);
        onGenerateClickFn();

    </script>
</body>

</html>