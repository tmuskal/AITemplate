<html>
<head><meta charset="utf-8">
<title>Riff Lightning Diffusion</title>
</head>
<body>
    <h1>Riff Lightning Diffusion</h1>
    <label for="prompt">Prompt:</label>
    <textarea id="prompt" rows="10" cols="80"></textarea>    
    <button id="generate">Generate</button>
    <div id="output"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script>
        var defaultPrompt = "photo of a unicorn";
        // override default prompt with URL parameter
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('prompt')) {
            defaultPrompt = urlParams.get('prompt');
        }
        $("#prompt").val(defaultPrompt);

        var n = 3;
        if (urlParams.has('n')) {
            n = urlParams.get('n');
        }
        var steps = 15;
        if (urlParams.has('steps')) {
            steps = urlParams.get('steps');
        }
        var strength = 0.3;
        if (urlParams.has('strength')) {
            strength = urlParams.get('strength');
        }
        var seed = 1512;
        if (urlParams.has('seed')) {
            seed = urlParams.get('seed');
            seed = parseInt(seed);
        }
        var factor = 1.3;
        if (urlParams.has('factor')) {
            factor = urlParams.get('factor');
            factor = parseFloat(factor);
        }
        
        var onGenerateClickFn =function() {
            var prompt = $('#prompt').val();
            $('#output').html('');
            
            for (var i = 0; i < n; i++) {
                var img = $('<img>');
                var Href = '/?prompt=' + encodeURIComponent(prompt)+'&steps='+steps+'&seed=' + (seed + i+1);
                img.attr('src', Href);
                img.click(imageClick);
                $('#output').append(img);
            }            
        }
        var imageClick = function(){
            theimg = $(this);
            var url = theimg.attr('src');            
            var urlParams2 = new URLSearchParams(url.split('?')[1]);
            var prompt = $('#prompt').val();
            var newsteps = parseInt(urlParams2.get('steps'));
            var newseed = parseInt(urlParams2.get('seed'));
            var oldprompt = urlParams2.get('prompt');
            if(oldprompt == prompt){                
                newsteps = newsteps * factor;                
                newsteps = Math.round(newsteps);
                newsteps = Math.max(newsteps, 1);
                newsteps = Math.min(newsteps, 200);
            }


            $('#output').html('');
            for(var i = 0; i < n; i++){
                var img = $('<img>');
                var newHref = '/?prompt=' + encodeURIComponent(prompt)+'&steps='+newsteps+'&seed='+(newseed+i+1)+"&strength="+strength + "&origImage=" + encodeURIComponent(url);
                img.attr('src', newHref);
                img.click(imageClick);
                $('#output').append(img);
            }
        }
        $('#generate').click(onGenerateClickFn);
        onGenerateClickFn();

    </script>
</body>

</html>